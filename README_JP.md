Kelp
====

FIR 畳み込み機能つきオーディオプレーヤ GUI

```
% python Kelp/gui.py
```

![screen_shot](https://user-images.githubusercontent.com/8520833/94340636-5c36ce00-003e-11eb-9398-7c9705380106.png)


Requirements
------------

* Python3
* PortAudio, PyAudio
* NumPy
* PyQt5


ファイルフォーマット
----------------

### 音源

WAVE ファイル (16/24/32 bit 整数型) に対応。


### FIR

FIR 係数データは NumPy のバイナリファイルフォーマットで書かれた `.npy` ファイルから読み込みます。

以下のように２種類の畳み込みモードがあり，FIR データの配列形状に応じて切り替えます：

* **SISO mode with 1D array**
–
FIR の次元が 1 の場合は，SISO システムの FIR として扱います。
多チャンネルの音源信号に対しては，各チャンネルにそれぞれ FIR を適用します。

* **MIMO mode with 3D array**
–
FIR の次元が 3 の場合は， MIMO/MISO/SIMO システムの FIR として扱います。
クロストークのある処理ができます。
0, 1, 2 軸はそれぞれ，出力チャンネル，入力チャンネル，時間タップとします。
音源のチャンネル数と FIR の入力チャンネル数が一致しない場合，再生できません。


操作
---

* **プレイリスト構築**
–
`.wav`ファイルや`.npy`ファイルをプレイリスト欄にドロップして音源や FIR をプレイリスト上に構成します。
複数のファイルをドロップすると，音源とFIRの全ての組み合わせをプレイリストに追加します。
プレイリスト内のアイテムを選択中に，`.wav`ファイルまたは`.npy`ファイルを１つだけドロップすると，選択中のアイテムが置き換わります。
選択中のアイテムがない場合は，プレイリスト最後尾に追加されます。

* **プレイリスト並び替え**
–
アイテムを選択してドラッグ&ドロップすると，ドロップ位置に移動します。
各列のヘッダーをクリックしてソートすることもできます。

* **再生デバイス設定**
–
右上のコンボボックスで選択します。
再生中にコンボボックスを開くと，再生が停止するので注意してください。

* **再生・一時停止**
–
Play/Pause ボタンで再生・一時停止ができます。
Space キーでも同様の操作ができます。

* **先頭から再生**
–
アイテムのファイル名をダブルクリックすると，それを最初から再生します。
アイテムを選択して Enter/Return キーでも同様の操作ができます。
処理的には FIR を再読み込みしています。

* **再生位置変更**
–
スライダーのつまみを移動します。

* **ゲイン調整**
–
マウスホイールを回すと 1 dB ステップで調整できます。
⌘キーを押しながらホイールを回すと 0.1 dB ステップになります。
ダブルクリックで 0 と -inf をトグルします。

* **ピークリセット**
–
ダブルクリックします。

* **書き出し**
–
プレイリスト内の選択したアイテムをバッチ処理で書き出すことができます。
書き出し先のパスを入力し，FFTポイントや`.wav`ファイルのビット幅を設定した後，"Export" ボタンを押し処理を開始します。

* **Escape Key**
–
プレイリスト上のアイテムの選択を解除します。

* **⌘+A Key**
–
プレイリスト上のアイテムを全選択します。

* **Delete/Backspace Key**
–
選択したアイテムの FIR を取り除きます。
FIR がない場合はアイテム自体をプレイリストから取り除きます。

* **⌘+S Key**
–
プレイリストをセーブします。
次回起動時や ⌘+R キーに，セーブしたプレイリストを復帰します。

* **⌘+R Key**
–
プレイリストを前回セーブした状態にロールバックします。

* **⌘+Q Key**
–
終了します。



Automator app
-------------

macOS で Dock などに置きたい場合は，Automator でシェルスクリプトを実行するアプリを作成するのがシンプルだと思います。手順は以下の通りです。

* Start Automator.app
* Choose "Application"
* Choose "Run Shell Script"
* For example, write the folowing scripts:

```
PATH_PYTHON="/path/to/python"
PATH_KELP="/path/to/kelp"
${PATH_PYTHON}/python ${PATH_KELP}/gui.py $@ > ${PATH_KELP}/log.txt
```
* Save the recipe

